<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
      <meta http-equiv="X-UA-Compatible" content="IE=Edge">
      <meta name="format-detection" content="telephone=no" />
      <meta http-equiv="Pragma" content="no-cache" />
      <meta http-equiv="Cache-Control" content="no-cache" />
      <meta http-equiv="Expires" content="0" />
    <title>首页</title>
    <link rel="stylesheet" href="__STATIC__/css/weui.css"/>
    <script type="text/javascript" src="__STATIC__/js/iscroll-probe.js"></script>
    <script type="text/javascript" src="__STATIC__/js/demoUtils.js"></script>
    <script type="text/javascript" src="__STATIC__/js/zepto.min.js"></script>
      <script  type="text/javascript" src="__STATIC__/js/fastclick.js"/>
      <script type="text/javascript">
          $(function() {
              FastClick.attach(document.body);
          });
      </script>
      <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
      <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
      <!--[if lt IE 9]>
      <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>

      <![endif]-->
      <style type="text/css">
          * {
              -webkit-box-sizing: border-box;
              -moz-box-sizing: border-box;
              box-sizing: border-box;
          }

          html {
              -ms-touch-action: none;
          }

          body,ul,li {
              padding: 0;
              margin: 0;
              border: 0;
          }

          body {
              display: block;
              font-size: 12px;
              font-family: ubuntu, helvetica, arial;
              overflow: hidden; /* this is important to prevent the whole page to bounce */
          }

          #header {
              position: absolute;
              z-index: 2;
              top: 0;
              left: 0;
              width: 100%;
              height: 45px;
              line-height: 45px;
              background: #CD235C;
              padding: 0;
              color: #eee;
              font-size: 20px;
              text-align: center;
              font-weight: bold;
          }

          #footer {
              position: absolute;
              z-index: 2;
              bottom: 0;
              left: 0;
              width: 100%;
              height: 48px;
              background: #444;
              padding: 0;
              border-top: 1px solid #444;
          }

          #wrapper,#wrapper2, #wrapper3 {
              position: absolute;
              z-index: 1;
              top: 45px;
              bottom: 48px;
              left: 0;
              width: 100%;
              background: #f1f4f6;
              /*overflow: hidden;*/
          }

          #scroller,#scroller2,#scroller3 {
              position: absolute;
              z-index: 1;
              -webkit-tap-highlight-color: rgba(0,0,0,0);
              width: 100%;
              /*height: 1280px;*/
              -webkit-transform: translateZ(0);
              -moz-transform: translateZ(0);
              -ms-transform: translateZ(0);
              -o-transform: translateZ(0);
              transform: translateZ(0);
              -webkit-touch-callout: none;
              -webkit-user-select: none;
              -moz-user-select: none;
              -ms-user-select: none;
              user-select: none;
              -webkit-text-size-adjust: none;
              -moz-text-size-adjust: none;
              -ms-text-size-adjust: none;
              -o-text-size-adjust: none;
              text-size-adjust: none;
          }

          #scroller ul,#scroller2 ul,#scroller3 ul {
              list-style: none;
              padding: 0;
              margin: 0;
              width: 100%;
              text-align: center;
          }

          #scroller li,#scroller2 li,#scroller3 li {
              padding: 0 10px;
              height: 40px;
              line-height: 40px;
              border-bottom: 1px solid #ccc;
              border-top: 1px solid #fff;
              background-color: #fafafa;
              font-size: 14px;
          }

          #wrapper p{position:absolute; text-align:center; height:3rem; line-height:3rem; color:red; width:100%;}

          #wrapper p.p-2{bottom:0;}

          .view-list {
              margin-top: 0px !important;
              background: #f1f4f6  !important;
          }
          .view-item{
              display: flex;
              height: 186px;
              margin-left: 14px;
              margin-right: 14px;
              margin-top: 14px;
              flex-direction: column;
              background-color: #FFFFFF;
          }
          .view-info{
              display: flex;
              height: 136px;
              padding: 14px;
              flex-direction: row;
              background-color: #FFFFFF;
              border-bottom: 1px solid #f3f3f3;
          }
          .view-right {
              display: flex;
              flex-direction: column;
              align-content: center;
              margin-left:14px;
              align-self: center;
          }
          .image-cover {
              /*width:104px;*/
              height:104px;
              display:block;
              align-self: center;
          }
          .jd-title{
              font-size: 14px;
              overflow: hidden;
              display: -webkit-box;
              -webkit-line-clamp: 2;
              -webkit-box-orient: vertical;
              word-break: break-all;

          }
          .jd-sell-price{
              display: flex;
              flex-direction: row;
              font-size: 12px;
              align-items: center;
              align-content: center;
              line-height: 16px;
              margin-top: 16px;
              color: #a7aaaa;
          }
          .jd-price{
              text-decoration:line-through;
              margin-left: 2px;
          }
          .jd-time {
              margin-left: 2px;
          }
          .img-money {
              width: 16px;
              height: 16px;
          }

          .jd-yj-price{
              display: flex;
              flex-direction: row;
              font-size: 12px;
              align-items: center;
              align-content: center;
              line-height: 16px;
              margin-top: 12px;
          }
          .jd-yj-title{
              margin-left: 6px;
          }
          .jd-yj-com-num{
              color: red;
          }
          .jd-commissionshare-title{
                margin-left: 16px;
          }
          .jd-commissionshare-num{
          }
          .jd-bottom{
              display: flex;
              flex-direction: column;
              width: 100%;
          }
          .weui-cell__ft{
              display: flex;
              flex-direction: row;
              align-content: center;
              align-items: center;
              width: 100%;
              height: 50px;
          }
          .weui-btn-collect {
              display: flex;
              margin: 0 auto;
              flex-direction: row;
              align-items: center;
              align-content: center;
              justify-content:center;
              font-size: 12px !important;
              width: 49%;
              height: 50px;
              line-height: 50px;
          }
          .weui-btn_push{
              display: flex;
              margin: 0 auto;
              flex-direction: row;
              align-items: center;
              justify-content:center;
              width: 49%;
              height: 50px;
              line-height: 50px;
          }
          .weui-btn-font {
              display: flex;
              font-size: 12px !important;
              justify-content: center;
              margin-left: 8px;
              margin-top: 4px;
          }
          .img-collect {
              width: 16px;
              height: 16px;
          }

          .line-view {
              height: 20px;
              width: 1px;
              background: #f3f3f3;
              align-self: center;
          }
      </style>
  </head>
  <body ontouchstart  onload="loaded()">
  <div class="weui-navbar">
      <div href="#tab1" class="weui-navbar__item weui-bar__item_on">
          按日期
      </div>
      <div href="#tab2" class="weui-navbar__item">
          按佣金
      </div>
      <div href="#tab3" class="weui-navbar__item">
          按价格
      </div>
  </div>



  <!--  </div> -->
  <div class="content">
      <div id="wrapper" style="display: block;">
          <div id="scroller">
              <!-- <ul>
                  <li id="-1">
                      <div class="item">
                          <img src="" class="item-img">


                      </div>
                  tieleeeeeeeeee:<button id="-1" style="">button</button>


                  </li>
              </ul> -->
              <div class="view-list">
                  <div class="view-item">
                      <div class="view-info">
                          <img src="https://img14.360buyimg.com/n0/jfs/t21235/25/2215358474/458789/b2b86e63/5b4c445dNf383b504.jpg" class="image-cover" alt="">
                          <div class="view-right">
                              <div class="jd-title">花花公子正品，有防伪标签花花公子正品有防伪标签花花公子正品，有防伪标签花花公子正品，有防伪标签</div>
                              <div class="jd-bottom">
                                  <div class="jd-sell-price">
                                      <div class="jd-coupon-price">券后价：¥ 89</div>
                                      <div class="jd-price">¥ 198</div>
                                      <div class="jd-time">截止：08.23</div>
                                  </div>
                                  <div class="jd-yj-price">
                                      <img src="__STATIC__/images/icon_money.png" class="img-money">
                                      <div class="jd-yj-title">佣金：</div>
                                      <div class="jd-yj-com-num">¥ 89</div>
                                      <div class="jd-commissionshare-title">占比：</div>
                                      <div class="jd-commissionshare-num">50%</div>
                                  </div>
                              </div>

                          </div>
                      </div>

                      <div class="weui-cell__ft">
                          <div skuId="0" class="weui-btn-collect"><img src="__STATIC__/images/icon_collect.png" class="img-collect"><div class="weui-btn-font">收藏</div></div>
                          <div class="line-view"></div>
                          <div skuId="1" class="weui-btn_push"><img src="__STATIC__/images/icon_wechat.png" class="img-collect"><div class="weui-btn-font">一键推广</div></div>
                      </div>
                  </div>
              </div>
          </div>
          <p class="p-1">下拉刷新</p>
          <p class="p-2">上拉加载</p>
      </div>

  </div>
  <!--BEGIN toast-->
  <div id="toast" style="display: none;">
      <div class="weui-mask_transparent"></div>
      <div class="weui-toast">
          <i class="weui-icon-success-no-circle weui-icon_toast"></i>
          <p class="weui-toast__content">已完成</p>
      </div>
  </div>
  <!--end toast-->
  <!-- loading toast -->
  <div id="loadingToast" style="display:none;">
      <div class="weui-mask_transparent"></div>
      <div class="weui-toast">
          <i class="weui-loading weui-icon_toast"></i>
          <p class="weui-toast__content">数据推送中</p>
      </div>
  </div>

  <script type="text/javascript">
      var myScroll;
      function loaded () {
          myScroll = new IScroll('#wrapper', {mouseWheel: true,preventDefault: false});
      }
      document.addEventListener('touchmove', function (e) { e.preventDefault(); }, isPassive() ? {
          capture: false,
          passive: false
      } : false);

      $(function(){
          var tabIndex = "#tab1";
          var preSort1 = 'desc';
          var preSort2 = 'desc';
          var preSort3 = 'desc';
          console.log("default-tab:"+tabIndex);
          $('.weui-navbar__item').on('click', function () {
              $(this).addClass('weui-bar__item_on').siblings('.weui-bar__item_on').removeClass('weui-bar__item_on');
              console.log(tabIndex===$(this).attr("href"));
              page = 0;
              myScroll.scrollTo(0, 0);
              if (tabIndex===$(this).attr("href")) {

                  initData(getSwitchTabSort(tabIndex));
              }else{
                  tabIndex = $(this).attr("href");
                  initData(getCurTabSort(tabIndex));
              }


              $(tabIndex).show().siblings().hide();

          });
          var page = 0;
          var size = 5;
          loaded();
          setJSAPI();
          initData(getCurTabSort(tabIndex));

          console.log("初始化数据："+myScroll.y + '&' + myScroll.maxScrollY);
          myScroll.on('scroll', refreshData);
          myScroll.on('scrollEnd', loadMore);

          function initData(sortIndex){
              console.log("initData");
              $('.view-list').empty();
              getdata(tabIndex,sortIndex, 0, size);
              //
              // index = 20;
              // myScroll.refresh();
          }
          function refreshData(){
              console.log("refreshData:"+myScroll.y);
              if (myScroll.y>60) {
                  console.log("开始刷新数据");
                  $('.view-list').empty();
                  initData(getCurTabSort(tabIndex));
                  console.log("刷新数据完成");
              }
          }
          function loadMore () {
              //var currentIndex = tabIndex;
              console.log(myScroll.y + '&' + myScroll.maxScrollY);
              if(myScroll.y <= myScroll.maxScrollY){
                  //position.innerHTML = this.y>>0;
                  console.log("滑动到最底部了");
                  // setTimeout(function(){
                  //     console.log("返回数据："+(currentIndex===tabIndex));
                  //     if (currentIndex===tabIndex) {
                  //         for (var i = index; i < index+20; i++) {
                  //             var li = '<li  class="link" id="'+i+'">'+tabIndex+'=Click me:'+i+'</li>';//onclick="item_click('+i+');"
                  //             $('.weui-cells').append(li);
                  //         }
                  //         index = index+20;
                  //         console.log("添加数据index:"+index);
                  //         myScroll.refresh();
                  //     }
                  // },1000);
                  getdata(tabIndex,getCurTabSort(tabIndex),page+1,size);
              }
          }

          function getdata(curTabIndex,sortIndex, curPage, pageSize){
              var index = 0;
              if (curTabIndex==='#tab1'){
                  index = 0;
              } else if (curTabIndex==='#tab2'){
                  index = 1;
              }else {
                  index = 2;
              }
              //http://localhost/jdwechatapp/public/unionjd/index/couponGoods
              //http://wx.microcodor.com/unionjd/index/couponGoods
              $.getJSON('http://wx.microcodor.com/unionjd/index/couponGoods', {'pageIndex':curPage*pageSize, 'pageSize': pageSize}, function(data) {
                  console.log('tabIndex:'+index+',sortIndex:'+sortIndex+',curPage:'+curPage+',pageSize:'+ pageSize);
                  if (curTabIndex!==tabIndex) {
                      getdata(tabIndex,sortIndex,0,size);
                      return;
                  }
                  console.log(data.length);
                  if (data===null) {
                      console.log("no data");
                      return;
                  }

                  for (var i = 0; i < data.length; i++) {
                      var obj = data[i];
                      var html = '<div class="view-item">\n' +
                          '                      <div class="view-info" skuId="'+obj.skuId+'" >\n' +
                          '                          <img src="http://img14.360buyimg.com/n1/'+obj.imageurl+'" class="image-cover" alt="">\n' +
                          '                          <div class="view-right">\n' +
                          '                              <div class="jd-title">'+obj.skuName+'</div>\n' +
                          '                              <div class="jd-bottom">\n' +
                          '                                  <div class="jd-sell-price">\n' +
                          '                                      <div class="jd-coupon-price">券后价：¥ '+(obj.wlPrice-obj.couponList[0].discount).toFixed(1)+'</div>\n' +
                          '                                      <div class="jd-price">¥ '+obj.wlPrice+'</div>\n' +
                          '                                      <div class="jd-time">截止：'+(new Date(obj.couponList[0].endTime).getMonth() + 1)+'.'+new Date(obj.couponList[0].endTime).getDate()+'</div>\n' +
                          '                                  </div>\n' +
                          '                                  <div class="jd-yj-price">\n' +
                          '                                      <img src="__STATIC__/images/icon_money.png" class="img-money">\n' +
                          '                                      <div class="jd-yj-title">佣金：</div>\n' +
                          '                                      <div class="jd-yj-com-num">¥ '+((obj.wlPrice-obj.couponList[0].discount)*(obj.wlCommissionShare/100).toFixed(2)).toFixed(2)+'</div>\n' +
                          '                                      <div class="jd-commissionshare-title">占比：</div>\n' +
                          '                                      <div class="jd-commissionshare-num">'+obj.wlCommissionShare+'%</div>\n' +
                          '                                  </div>\n' +
                          '                              </div>\n' +
                          '\n' +
                          '                          </div>\n' +
                          '                      </div>\n' +
                          '\n' +
                          '                      <div class="weui-cell__ft">\n' +
                          '                          <div skuId="'+obj.skuId+'" class="weui-btn-collect"><img src="__STATIC__/images/icon_collect.png" class="img-collect"><div class="weui-btn-font">收藏</div></div>\n' +
                          '                          <div class="line-view"></div>\n' +
                          '                          <div skuId="'+obj.skuId+'" class="weui-btn_push"><img src="__STATIC__/images/icon_wechat.png" class="img-collect"><div class="weui-btn-font">一键推广</div></div>\n' +
                          '                      </div>\n' +
                          '                  </div>';

                      // var html = '<div class="weui-cell" id="'+obj.skuId+'">\n' +
                      //     '                      <div class="weui-cell__hd"><img src="'+obj.imgUrl+'" alt="" style="width:100px;margin-right:5px;display:block"></div>\n' +
                      //     '                      <div class="weui-cell__bd">\n' +
                      //     '                          <div class="jd-title">'+obj.skuName+'</div>\n' +
                      //     '                          <div class="jd-price">京东价：¥'+obj.pcPrice+'</div>\n' +
                      //     '                          <div class="jd-bottom">\n' +
                      //     '                              <div class="jd-sell-price">\n' +
                      //     '                                  <div>内购价：¥'+obj.wlPrice+'</div>\n' +
                      //     '                                  <div>佣金：'+obj.wlCommission+'</div>\n' +
                      //     '                              </div>\n' +
                      //     '                              <div class="weui-cell__ft"><a href="javascript:void(0)" id="'+obj.skuId+'" class="weui-btn_push">一键推广</a></div>\n' +
                      //     '\n' +
                      //     '                          </div>\n' +
                      //     '\n' +
                      //     '                      </div>\n' +
                      //     '                  </div>';
                      $('.view-list').append(html);
                  }
              //http://wx.microcodor.com/index/index/getTabData
              // $.getJSON('http://wx.microcodor.com/index/index/getTabData', {'tabIndex': index, 'sortIndex':sortIndex, 'curPage':curPage, 'pageSize': pageSize}, function(data) {
              //     console.log('tabIndex:'+index+',sortIndex:'+sortIndex+',curPage:'+curPage+',pageSize:'+ pageSize);
              //     if (curTabIndex!==tabIndex) {
              //         getdata(tabIndex,sortIndex,0,size);
              //         return;
              //     }
              //     if (data===null||data.length===0) {
              //         console.log("no data");
              //         return;
              //     }
              //     console.log(data);
              //     console.log(data.length);
              //     for (var i = 0; i < data.length; i++) {
              //         var obj = data[i];
              //
              //         var html = '<div class="weui-cell" id="'+obj.id+'">\n' +
              //             '                      <div class="weui-cell__hd"><img src="'+obj.image+'" alt="" style="width:100px;margin-right:5px;display:block"></div>\n' +
              //             '                      <div class="weui-cell__bd">\n' +
              //             '                          <div class="jd-title">'+obj.sku_name+'</div>\n' +
              //             '                          <div class="jd-price">京东价：¥'+obj.price+'</div>\n' +
              //             '                          <div class="jd-bottom">\n' +
              //             '                              <div class="jd-sell-price">\n' +
              //             '                                  <div>内购价：¥'+obj.sell_price+'</div>\n' +
              //             '                                  <div>佣金：'+obj.commission+'%</div>\n' +
              //             '                              </div>\n' +
              //             '                              <div class="weui-cell__ft"><a href="javascript:void(0)" id="'+obj.id+'" class="weui-btn_push">一键推广</a></div>\n' +
              //             '\n' +
              //             '                          </div>\n' +
              //             '\n' +
              //             '                      </div>\n' +
              //             '                  </div>';
              //         $('.weui-cells').append(html);
              //     }
                  page = curPage;
                  myScroll.refresh();
              });
          }
          $('#scroller').on('click', '.view-list .view-info', function(event){
              var val=$(this).attr("skuId");
              console.log("click:"+val);
              window.location.href = "http://wx.microcodor.com/index/index/detail?id="+val;
          })
          var $loadingToast = $('#loadingToast');
          var $toast = $('#toast');
          function showLoading(){
              if ($loadingToast.css('display') != 'none') return;

              $loadingToast.fadeIn(100);
          }
          function hideLoading(){
              setTimeout(function () {
                  $loadingToast.fadeOut(100);
              }, 500);
          }
          function showToast(){
              if ($toast.css('display') != 'none') return;

              $toast.fadeIn(100);
              setTimeout(function () {
                  $toast.fadeOut(100);
              }, 2000);
          }

          //weui-btn-collect
          $('.view-list').on('click', '.view-item .weui-btn-collect', function(e){
              var val=$(this).attr("skuId");
              //alert("button click:"+val);
              ///showLoading();
              $(this).children(".img-collect").attr("src","__STATIC__/images/icon_collect_pressed.png");
              $(this).children(".weui-btn-font").html("已收藏");
              // $.ajax({
              //     type: "GET",
              //     url: "http://wx.microcodor.com/index/index/push",
              //     data: {id:val},
              //     dataType: "json",
              //     success: function(data){
              //         console.log(data);
              //         hideLoading();
              //         if (data.result){
              //             showToast();
              //         }
              //     },
              //     error: function () {
              //         hideLoading();
              //
              //     }
              // });

              e.preventDefault();
          })

          $('.view-list').on('click', '.view-item .weui-btn_push', function(e){
              var val=$(this).attr("skuId");
              console.log("button click:"+val);
              showLoading();
              $.ajax({
                  type: "GET",
                  url: "http://wx.microcodor.com/index/index/push",
                  data: {id:val},
                  dataType: "json",
                  success: function(data){
                      console.log(data);
                      hideLoading();
                      if (data.result){
                          showToast();
                      }
                  },
                  error: function () {
                      hideLoading();

                  }
              });

              e.preventDefault();
          })
          function getSwitchTabSort(curTabIndex){
              if (curTabIndex==='#tab1'){
                  preSort1 = preSort1==='desc'?'asc':'desc';
                  return preSort1;
              } else if (curTabIndex==='#tab2'){
                  preSort2 = preSort2==='desc'?'asc':'desc';
                  return preSort2;
              }else {
                  preSort3 = preSort3==='desc'?'asc':'desc';
                  return preSort3;
              }
          }
          function getCurTabSort(curTabIndex){
              if (curTabIndex==='#tab1'){
                  return preSort1;
              } else if (curTabIndex==='#tab2'){
                  return preSort2;
              }else {
                  return preSort3;
              }
          }
          function setJSAPI(){
              var option = {
                  title: 'WeUI, 为微信 Web 服务量身设计',
                  desc: 'WeUI, 为微信 Web 服务量身设计',
                  link: "https://weui.io",
                  imgUrl: 'https://mmbiz.qpic.cn/mmemoticon/ajNVdqHZLLA16apETUPXh9Q5GLpSic7lGuiaic0jqMt4UY8P4KHSBpEWgM7uMlbxxnVR7596b3NPjUfwg7cFbfCtA/0'
              };
              var url =location.href.split('#')[0];
              console.log("url:"+url);
              //$.getJSON('auth/index?&url=' + encodeURIComponent(location.href.split('#')[0]), function (res) {
              //http://localhost/jdwechatapp/public/auth/index
              $.getJSON('http://wx.microcodor.com/auth/index',{"url": url}, function (res) {
                  console.log(res);
                  wx.config({
                      beta: true,
                      debug: true,
                      appId: res.appId,
                      timestamp: res.timestamp,
                      nonceStr: res.nonceStr,
                      signature: res.signature,
                      jsApiList: [
                          'onMenuShareTimeline',
                          'onMenuShareAppMessage',
                          'onMenuShareQQ',
                          'onMenuShareWeibo',
                          'onMenuShareQZone',
                          // 'setNavigationBarColor',
                          'setBounceBackground'
                      ]
                  });
                  wx.ready(function () {
                      pushshare();

                  });
                  wx.error(function () {
                      console.log('config error');
                  });
              });
          }
          function pushshare() {
              var option = {
                  imgUrl: "https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=4173425533,1640870677&fm=27&gp=0.jpg", // 分享图标
                  //type: '', // 分享类型,music、video或link，不填默认为link
                  //dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                  title: "京乐推",
                  desc: "京东爆品分享，优惠券折扣",
                  link: "http://wx.microcodor.com/index/index/main",
                  success: function () {
                      console.log('分享成功');
                  },
                  cancel: function () {
                      console.log('分享失败');
                  }
              };
              wx.onMenuShareAppMessage(option);
              wx.onMenuShareTimeline(option);
              console.log("share-main")
          }
      });
  </script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script src="https://res.wx.qq.com/open/libs/weuijs/1.0.0/weui.min.js"></script>
  </body>
</html>
