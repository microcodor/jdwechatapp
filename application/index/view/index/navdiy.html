<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
      <meta http-equiv="X-UA-Compatible" content="IE=Edge">
      <meta name="format-detection" content="telephone=no" />
      <meta http-equiv="Pragma" content="no-cache" />
      <meta http-equiv="Cache-Control" content="no-cache" />
      <meta http-equiv="Expires" content="0" />
    <title>首页</title>
    <link rel="stylesheet" href="__STATIC__/css/weui.css"/>
    <script type="text/javascript" src="__STATIC__/js/iscroll-probe.js"></script>
    <script type="text/javascript" src="__STATIC__/js/demoUtils.js"></script>
    <script type="text/javascript" src="__STATIC__/js/zepto.min.js"></script>

      <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
      <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
      <!--[if lt IE 9]>
      <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
      <![endif]-->
      <style type="text/css">
          * {
              -webkit-box-sizing: border-box;
              -moz-box-sizing: border-box;
              box-sizing: border-box;
          }

          html {
              -ms-touch-action: none;
          }

          body,ul,li {
              padding: 0;
              margin: 0;
              border: 0;
          }

          body {
              display: block;
              font-size: 12px;
              font-family: ubuntu, helvetica, arial;
              overflow: hidden; /* this is important to prevent the whole page to bounce */
          }

          #header {
              position: absolute;
              z-index: 2;
              top: 0;
              left: 0;
              width: 100%;
              height: 45px;
              line-height: 45px;
              background: #CD235C;
              padding: 0;
              color: #eee;
              font-size: 20px;
              text-align: center;
              font-weight: bold;
          }

          #footer {
              position: absolute;
              z-index: 2;
              bottom: 0;
              left: 0;
              width: 100%;
              height: 48px;
              background: #444;
              padding: 0;
              border-top: 1px solid #444;
          }

          #wrapper,#wrapper2, #wrapper3 {
              position: absolute;
              z-index: 1;
              top: 45px;
              bottom: 48px;
              left: 0;
              width: 100%;
              background: #ccc;
              /*overflow: hidden;*/
          }

          #scroller,#scroller2,#scroller3 {
              position: absolute;
              z-index: 1;
              -webkit-tap-highlight-color: rgba(0,0,0,0);
              width: 100%;
              /*height: 1280px;*/
              -webkit-transform: translateZ(0);
              -moz-transform: translateZ(0);
              -ms-transform: translateZ(0);
              -o-transform: translateZ(0);
              transform: translateZ(0);
              -webkit-touch-callout: none;
              -webkit-user-select: none;
              -moz-user-select: none;
              -ms-user-select: none;
              user-select: none;
              -webkit-text-size-adjust: none;
              -moz-text-size-adjust: none;
              -ms-text-size-adjust: none;
              -o-text-size-adjust: none;
              text-size-adjust: none;
          }

          #scroller ul,#scroller2 ul,#scroller3 ul {
              list-style: none;
              padding: 0;
              margin: 0;
              width: 100%;
              text-align: center;
          }

          #scroller li,#scroller2 li,#scroller3 li {
              padding: 0 10px;
              height: 40px;
              line-height: 40px;
              border-bottom: 1px solid #ccc;
              border-top: 1px solid #fff;
              background-color: #fafafa;
              font-size: 14px;
          }

          #wrapper p{position:absolute; text-align:center; height:3rem; line-height:3rem; color:red; width:100%;}

          #wrapper p.p-2{bottom:0;}

          .weui-cells {
              margin-top: 0px !important;
          }
          .weui-cell{
              display: flex;
              height: 120px;
              flex-direction: row;
          }
          .weui-cell__bd {
              display: flex;
              flex-direction: column;
              align-content: center;
              margin-left: 6px;
          }
          .jd-title{
              font-size: 12px;
              overflow: hidden;
              display: -webkit-box;
              -webkit-line-clamp: 2;
              -webkit-box-orient: vertical;
              word-break: break-all;
              margin-top: 10px;
          }
          .jd-price{
              font-size: 10px;
              color: gray;
              text-decoration:line-through;
              margin-top: 5px;
          }
          .jd-sell-price{
              display: flex;
              flex-direction: column;
              font-size: 10px;
              color: red;
          }
          .jd-bottom{
              display: flex;
              flex-direction: row;
              width: 100%;
              position: relative;
          }
          .weui-cell__ft{
              position:absolute;
              right:0px;
              float: right;
          }
          .weui-btn_push{
              font-size: 10px !important;
              background-color: #1AAD19;
              box-sizing: border-box;
              font-size: 18px;
              text-align: center;
              text-decoration: none;
              color: #FFFFFF;
              line-height: 2.55555556;
              border-radius: 5px;
              padding: 5px;
          }
      </style>
  </head>
  <body ontouchstart  onload="loaded()">
  <div class="weui-navbar">
      <div href="#tab1" class="weui-navbar__item weui-bar__item_on">
          按日期
      </div>
      <div href="#tab2" class="weui-navbar__item">
          按佣金
      </div>
      <div href="#tab3" class="weui-navbar__item">
          按价格
      </div>
  </div>



  <!--  </div> -->
  <div class="content">
      <div id="wrapper" style="display: block;">
          <div id="scroller">
              <!-- <ul>
                  <li id="-1">
                      <div class="item">
                          <img src="" class="item-img">


                      </div>
                  tieleeeeeeeeee:<button id="-1" style="">button</button>


                  </li>
              </ul> -->
              <div class="weui-cells">
                  <div class="weui-cell">
                      <div class="weui-cell__hd"><img src="https://img14.360buyimg.com/n0/jfs/t21235/25/2215358474/458789/b2b86e63/5b4c445dNf383b504.jpg" alt="" style="width:100px;margin-right:5px;display:block"></div>
                      <div class="weui-cell__bd">
                          <div class="jd-title">花花公子正品，有防伪标签花花公子正品有防伪标签花花公子正品，有防伪标签花花公子正品，有防伪标签</div>
                          <div class="jd-price">京东价：¥198</div>
                          <div class="jd-bottom">
                              <div class="jd-sell-price">
                                  <div>内购价：¥89（券后）</div>
                                  <div>佣金：20%</div>
                              </div>
                              <div class="weui-cell__ft"><a href="javascript:pushsku(0);" class="weui-btn_push">一键推广</a></div>

                          </div>

                      </div>
                  </div>
              </div>
          </div>
          <p class="p-1">下拉刷新</p>
          <p class="p-2">上拉加载</p>
      </div>

  </div>
  <!--BEGIN toast-->
  <div id="toast" style="display: none;">
      <div class="weui-mask_transparent"></div>
      <div class="weui-toast">
          <i class="weui-icon-success-no-circle weui-icon_toast"></i>
          <p class="weui-toast__content">已完成</p>
      </div>
  </div>
  <!--end toast-->
  <!-- loading toast -->
  <div id="loadingToast" style="display:none;">
      <div class="weui-mask_transparent"></div>
      <div class="weui-toast">
          <i class="weui-loading weui-icon_toast"></i>
          <p class="weui-toast__content">数据推送中</p>
      </div>
  </div>

  <script type="text/javascript">
      var myScroll;
      function loaded () {
          myScroll = new IScroll('#wrapper', {mouseWheel: true,preventDefault: false});
      }
      document.addEventListener('touchmove', function (e) { e.preventDefault(); }, isPassive() ? {
          capture: false,
          passive: false
      } : false);



      $(function(){
          var tabIndex = "#tab1";
          var preSort1 = 'desc';
          var preSort2 = 'desc';
          var preSort3 = 'desc';
          console.log("default-tab:"+tabIndex);
          $('.weui-navbar__item').on('click', function () {
              $(this).addClass('weui-bar__item_on').siblings('.weui-bar__item_on').removeClass('weui-bar__item_on');
              console.log(tabIndex===$(this).attr("href"));
              page = 0;
              myScroll.scrollTo(0, 0);
              if (tabIndex===$(this).attr("href")) {

                  initData(getSwitchTabSort(tabIndex));
              }else{
                  tabIndex = $(this).attr("href");
                  initData(getCurTabSort(tabIndex));
              }


              $(tabIndex).show().siblings().hide();

          });
          var page = 0;
          var size = 5;
          loaded();
          initData(getCurTabSort(tabIndex));

          console.log("初始化数据："+myScroll.y + '&' + myScroll.maxScrollY);
          myScroll.on('scroll', refreshData);
          myScroll.on('scrollEnd', loadMore);

          function initData(sortIndex){
              console.log("initData");
              $('.weui-cells').empty();
              getdata(tabIndex,sortIndex, 0, size);
              //
              // index = 20;
              // myScroll.refresh();
          }
          function refreshData(){
              console.log("refreshData:"+myScroll.y);
              if (myScroll.y>60) {
                  console.log("开始刷新数据");
                  $('.weui-cells').empty();
                  initData(getCurTabSort(tabIndex));
                  console.log("刷新数据完成");
              }
          }
          function loadMore () {
              //var currentIndex = tabIndex;
              console.log(myScroll.y + '&' + myScroll.maxScrollY);
              if(myScroll.y <= myScroll.maxScrollY){
                  //position.innerHTML = this.y>>0;
                  console.log("滑动到最底部了");
                  // setTimeout(function(){
                  //     console.log("返回数据："+(currentIndex===tabIndex));
                  //     if (currentIndex===tabIndex) {
                  //         for (var i = index; i < index+20; i++) {
                  //             var li = '<li  class="link" id="'+i+'">'+tabIndex+'=Click me:'+i+'</li>';//onclick="item_click('+i+');"
                  //             $('.weui-cells').append(li);
                  //         }
                  //         index = index+20;
                  //         console.log("添加数据index:"+index);
                  //         myScroll.refresh();
                  //     }
                  // },1000);
                  getdata(tabIndex,getCurTabSort(tabIndex),page+1,size);
              }
          }

          function getdata(curTabIndex,sortIndex, curPage, pageSize){
              var index = 0;
              if (curTabIndex==='#tab1'){
                  index = 0;
              } else if (curTabIndex==='#tab2'){
                  index = 1;
              }else {
                  index = 2;
              }
              //http://wx.microcodor.com/index/index/getTabData
              $.getJSON('http://wx.microcodor.com/index/index/getTabData', {'tabIndex': index, 'sortIndex':sortIndex, 'curPage':curPage, 'pageSize': pageSize}, function(data) {
                  console.log('tabIndex:'+index+',sortIndex:'+sortIndex+',curPage:'+curPage+',pageSize:'+ pageSize);
                  if (curTabIndex!==tabIndex) {
                      getdata(tabIndex,sortIndex,0,size);
                      return;
                  }
                  if (data===null||data.length===0) {
                      console.log("no data");
                      return;
                  }
                  console.log(data);
                  console.log(data.length);
                  for (var i = 0; i < data.length; i++) {
                      var obj = data[i];

                      var html = '<div class="weui-cell" id="'+obj.id+'">\n' +
                          '                      <div class="weui-cell__hd"><img src="'+obj.image+'" alt="" style="width:100px;margin-right:5px;display:block"></div>\n' +
                          '                      <div class="weui-cell__bd">\n' +
                          '                          <div class="jd-title">'+obj.sku_name+'</div>\n' +
                          '                          <div class="jd-price">京东价：¥'+obj.price+'</div>\n' +
                          '                          <div class="jd-bottom">\n' +
                          '                              <div class="jd-sell-price">\n' +
                          '                                  <div>内购价：¥'+obj.sell_price+'</div>\n' +
                          '                                  <div>佣金：'+obj.commission+'%</div>\n' +
                          '                              </div>\n' +
                          '                              <div class="weui-cell__ft"><a href="javascript:void(0)" id="'+obj.id+'" class="weui-btn_push">一键推广</a></div>\n' +
                          '\n' +
                          '                          </div>\n' +
                          '\n' +
                          '                      </div>\n' +
                          '                  </div>';
                      // var html = '<div class="weui-cell">\n' +
                      //     '                      <div class="weui-cell__hd"><img src="'+obj.image+'" alt="" style="width:80px;margin-right:5px;display:block"></div>\n' +
                      //     '                      <div class="weui-cell__bd">\n' +
                      //     '                          <div class="jd-title">'+obj.sku_name+'</div>\n' +
                      //     '                          <div class="jd-price">京东价：¥'+obj.price+'</div>\n' +
                      //     '                          <div class="jd-sell-price">\n' +
                      //     '                              <div>内购价：¥'+obj.sell_price+'（券后）</div>\n' +
                      //     '                              <div>佣金：'+obj.commission+'%</div>\n' +
                      //     '                          </div>\n' +
                      //     '                      </div>\n' +
                      //     '                      <div class="weui-cell__ft"><a href="javascript:pushsku('+obj.id+');" class="weui-btn weui-btn_mini weui-btn_primary">一键推广</a></div>\n' +
                      //     '                  </div>';
                      $('.weui-cells').append(html);
                  }
                  page = curPage;
                  myScroll.refresh();
              });
          }
          $('#scroller').on('click', '.weui-cells .weui-cell', function(event){
              var val=$(this).attr("id");
              console.log("click:"+val);
              window.location.href = "http://wx.microcodor.com/index/index/detail?id="+val;
          })
          var $loadingToast = $('#loadingToast');
          var $toast = $('#toast');
          function showLoading(){
              if ($loadingToast.css('display') != 'none') return;

              $loadingToast.fadeIn(100);
          }
          function hideLoading(){
              setTimeout(function () {
                  $loadingToast.fadeOut(100);
              }, 500);
          }
          function showToast(){
              if ($toast.css('display') != 'none') return;

              $toast.fadeIn(100);
              setTimeout(function () {
                  $toast.fadeOut(100);
              }, 2000);
          }


          $('.weui-cells').on('touchend', '.weui-cell .weui-btn_push', function(e){
              var val=$(this).attr("id");
              console.log("button click:"+val);
              showLoading();
              $.ajax({
                  type: "GET",
                  url: "http://wx.microcodor.com/index/index/push",
                  data: {id:val},
                  dataType: "json",
                  success: function(data){
                      console.log(data);
                      hideLoading();
                      if (data.result){
                          showToast();
                      }
                  },
                  error: function () {
                      hideLoading();

                  }
              });

              e.preventDefault();
          })
          function getSwitchTabSort(curTabIndex){
              if (curTabIndex==='#tab1'){
                  preSort1 = preSort1==='desc'?'asc':'desc';
                  return preSort1;
              } else if (curTabIndex==='#tab2'){
                  preSort2 = preSort2==='desc'?'asc':'desc';
                  return preSort2;
              }else {
                  preSort3 = preSort3==='desc'?'asc':'desc';
                  return preSort3;
              }
          }
          function getCurTabSort(curTabIndex){
              if (curTabIndex==='#tab1'){
                  return preSort1;
              } else if (curTabIndex==='#tab2'){
                  return preSort2;
              }else {
                  return preSort3;
              }
          }

      });
  </script>

            <script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script src="https://res.wx.qq.com/open/libs/weuijs/1.0.0/weui.min.js"></script>
  <script src="__STATIC__/js/example.js"></script>


  </body>
</html>
